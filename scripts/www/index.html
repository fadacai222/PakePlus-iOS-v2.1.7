<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#070b16" />
  <title>ğŸ° ä»Šå¤©åƒå•¥ Â· éœ“è™¹å¼€ç®±ï¼ˆæ‰‹æœºç‰ˆï¼‰</title>
  <style>
    :root{
      --bg0:#070b16;
      --bg1:#0b1220;
      --panel:#0f172a;
      --panel2:#0b1220;
      --stroke:#1e3a8a;
      --stroke2:#60a5fa;
      --ok:#34d399;
      --warn:#fb7185;
      --gold:#fbbf24;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --cyan:#22d3ee;
      --lime:#22c55e;
      --pink:#fb7185;
      --violet:#a78bfa;
      --orange:#f59e0b;
      --blue:#60a5fa;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.45);
      --r: 18px;
      --r2: 22px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC","Microsoft YaHei", "Noto Sans CJK SC", Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 70% -10%, rgba(96,165,250,.22), transparent 55%),
                  radial-gradient(900px 700px at -10% 20%, rgba(34,211,238,.14), transparent 55%),
                  radial-gradient(700px 600px at 80% 120%, rgba(167,139,250,.14), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Background FX canvas */
    #bgFx{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
    }

    .app{
      position:relative;
      z-index:1;
      min-height:100%;
      padding: max(14px, env(safe-area-inset-top)) 14px max(18px, env(safe-area-inset-bottom));
      display:flex;
      flex-direction:column;
      gap:12px;
      max-width: 520px;
      margin: 0 auto;
    }

    .hud{
      border-radius: var(--r2);
      background: rgba(11,18,32,.72);
      border: 1px solid rgba(96,165,250,.22);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .hudTop{
      padding:14px 14px 10px;
      background: linear-gradient(180deg, rgba(17,31,53,.9), rgba(11,18,32,.65));
      border-bottom: 1px solid rgba(96,165,250,.18);
    }
    .title{
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
      letter-spacing: .3px;
      font-size: 18px;
      line-height: 1.15;
    }
    .title .badge{
      width:34px; height:34px; border-radius:12px;
      display:grid; place-items:center;
      background: radial-gradient(circle at 30% 30%, rgba(251,191,36,.95), rgba(245,158,11,.2));
      box-shadow: 0 0 0 2px rgba(251,191,36,.22), 0 18px 40px rgba(251,191,36,.18);
    }
    .sub{
      margin-top:6px;
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }

    .hudBottom{
      padding:12px 14px 14px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .status{
      font-size:12px;
      color: rgba(147,197,253,.95);
      font-weight: 700;
      display:flex; align-items:center; gap:8px;
      flex: 1 1 auto;
      min-width: 180px;
    }
    .dot{
      width:9px; height:9px; border-radius:50%;
      background: rgba(147,197,253,.9);
      box-shadow: 0 0 14px rgba(147,197,253,.55);
    }

    .btn{
      appearance:none; border:none;
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 900;
      color: #fff;
      background: linear-gradient(180deg, rgba(29,78,216,1), rgba(37,99,235,1));
      box-shadow: 0 10px 30px rgba(29,78,216,.35), 0 0 0 1px rgba(96,165,250,.28) inset;
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; justify-content:center;
      gap:8px;
      min-height: 44px;
      min-width: 145px;
      transition: transform .08s ease, filter .18s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); filter: brightness(.98); }
    .btn[disabled]{ opacity:.55; filter:grayscale(.35); cursor:not-allowed; }

    .btn.secondary{
      background: linear-gradient(180deg, rgba(16,185,129,1), rgba(52,211,153,1));
      box-shadow: 0 10px 30px rgba(16,185,129,.25), 0 0 0 1px rgba(52,211,153,.22) inset;
      min-width: 120px;
    }
    .btn.ghost{
      background: linear-gradient(180deg, rgba(51,65,85,1), rgba(71,85,105,1));
      box-shadow: 0 10px 30px rgba(0,0,0,.25), 0 0 0 1px rgba(148,163,184,.18) inset;
      min-width: 120px;
    }

    .banner{
      padding: 12px 14px;
      border-radius: var(--r2);
      background: rgba(15,23,42,.74);
      border: 1px solid rgba(251,191,36,.22);
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      gap:10px;
      backdrop-filter: blur(10px);
    }
    .banner .bolt{
      width:34px; height:34px; border-radius:14px;
      display:grid; place-items:center;
      background: radial-gradient(circle at 30% 30%, rgba(251,191,36,.95), rgba(251,191,36,.1));
      box-shadow: 0 0 0 2px rgba(251,191,36,.18), 0 18px 40px rgba(251,191,36,.18);
    }
    .bannerText{
      font-weight: 900;
      color: var(--gold);
      letter-spacing: .2px;
      font-size: 14px;
    }

    .reels{
      border-radius: var(--r2);
      background: rgba(15,23,42,.72);
      border: 1px solid rgba(96,165,250,.18);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .reelsInner{ padding: 14px; display:flex; flex-direction:column; gap:12px; }

    .reel{
      border-radius: 20px;
      background: rgba(11,18,32,.86);
      border: 1px solid rgba(30,58,138,.55);
      overflow:hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      position:relative;
    }
    .reelHeader{
      padding: 10px 12px;
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg, rgba(17,31,53,.92), rgba(15,23,42,.7));
      border-bottom: 1px solid rgba(96,165,250,.14);
    }
    .reelTitle{
      font-weight: 900;
      font-size: 13px;
      color: rgba(147,197,253,.95);
      display:flex; align-items:center; gap:8px;
    }
    .pill{
      font-size: 11px;
      font-weight: 900;
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(96,165,250,.12);
      border: 1px solid rgba(96,165,250,.18);
      color: rgba(147,197,253,.95);
      white-space:nowrap;
    }

    .viewport{
      padding: 12px;
      position:relative;
    }
    .card{
      border-radius: 18px;
      background: rgba(15,23,42,.9);
      border: 1px solid rgba(96,165,250,.22);
      padding: 12px 12px 12px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-60px -60px auto auto;
      width:140px; height:140px;
      background: radial-gradient(circle at 30% 30%, rgba(34,211,238,.22), transparent 60%);
      transform: rotate(15deg);
      pointer-events:none;
    }
    .name{
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .price{
      margin-top:6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .glowbar{
      margin-top: 12px;
      height: 8px;
      border-radius: 999px;
      background: rgba(148,163,184,.14);
      border: 1px solid rgba(148,163,184,.14);
      overflow:hidden;
    }
    .glowbar > i{
      display:block;
      height:100%;
      width:0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(34,211,238,.9), rgba(96,165,250,.9), rgba(167,139,250,.9));
      box-shadow: 0 0 22px rgba(96,165,250,.35);
      transition: width .1s linear;
    }

    .shake{
      animation: shake .12s ease-in-out 2;
    }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-2px); }
      50%{ transform: translateX(2px); }
      75%{ transform: translateX(-1px); }
      100%{ transform: translateX(0); }
    }
    .pop{
      animation: pop .22s cubic-bezier(.2,.9,.2,1.2) 1;
    }
    @keyframes pop{
      0%{ transform: scale(.98); }
      60%{ transform: scale(1.03); }
      100%{ transform: scale(1); }
    }

    .actions{
      display:flex;
      gap:10px;
      margin-top: 12px;
    }
    .actions .btn{ flex:1 1 0; min-width: 0; }

    .settings{
      border-radius: var(--r2);
      background: rgba(11,18,32,.72);
      border: 1px solid rgba(96,165,250,.16);
      box-shadow: var(--shadow2);
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    .settings h3{
      margin:0 0 10px;
      font-size: 14px;
      font-weight: 1000;
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding: 8px 0;
      border-bottom: 1px dashed rgba(148,163,184,.18);
    }
    .row:last-child{ border-bottom:none; }
    .row label{ font-size: 12px; color: rgba(229,231,235,.92); font-weight: 800; }
    .hint{ font-size: 11px; color: var(--muted); margin-top: 8px; line-height: 1.35; }
    .tog{
      display:flex; align-items:center; gap:8px;
      font-size: 11px; color: rgba(156,163,175,.95);
      font-weight: 800;
    }
    .switch{
      width: 46px; height: 26px;
      background: rgba(148,163,184,.22);
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.22);
      position:relative;
      cursor:pointer;
      flex: 0 0 auto;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.1);
      transition: background .15s ease;
    }
    .switch::after{
      content:"";
      width: 22px; height: 22px;
      position:absolute; top:1px; left:1px;
      border-radius: 50%;
      background: rgba(229,231,235,.95);
      box-shadow: 0 6px 14px rgba(0,0,0,.25);
      transition: transform .15s ease;
    }
    .switch.on{
      background: rgba(52,211,153,.28);
      border-color: rgba(52,211,153,.28);
    }
    .switch.on::after{ transform: translateX(20px); }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding: 6px 0 2px;
    }
    .chip{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(96,165,250,.18);
      background: rgba(15,23,42,.7);
      color: rgba(229,231,235,.9);
      font-size: 12px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .chip:active{ transform: scale(.99); }
    .chip.on{
      border-color: rgba(52,211,153,.35);
      background: rgba(16,185,129,.18);
      box-shadow: 0 0 0 1px rgba(52,211,153,.14) inset;
    }

    .history{
      border-radius: var(--r2);
      background: rgba(11,18,32,.72);
      border: 1px solid rgba(96,165,250,.16);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .historyTop{
      padding: 12px 14px;
      background: linear-gradient(180deg, rgba(17,31,53,.88), rgba(11,18,32,.65));
      border-bottom: 1px solid rgba(96,165,250,.14);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .historyTop h3{ margin:0; font-size: 14px; font-weight: 1000; }
    .historyList{
      padding: 12px 14px 14px;
      display:flex; flex-direction:column;
      gap:10px;
    }
    .hitem{
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(15,23,42,.8);
      border: 1px solid rgba(148,163,184,.14);
    }
    .hitem .line{
      font-size: 12px;
      font-weight: 900;
      color: rgba(229,231,235,.92);
      line-height:1.35;
    }
    .hitem .small{
      font-size: 11px;
      color: rgba(156,163,175,.92);
      margin-top:4px;
      font-weight: 800;
    }
    .hitem .sep{ opacity:.35; margin: 0 6px; }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      z-index: 50;
      background: rgba(0,0,0,.55);
      padding: 18px 14px;
      backdrop-filter: blur(7px);
    }
    .modal.show{ display:flex; align-items:center; justify-content:center; }
    .modalCard{
      width:min(520px, 100%);
      border-radius: 22px;
      background: rgba(11,18,32,.92);
      border: 2px solid rgba(96,165,250,.6);
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateY(10px) scale(.985);
      animation: modalIn .2s cubic-bezier(.2,.9,.2,1.2) forwards;
    }
    @keyframes modalIn{
      to{ transform: translateY(0) scale(1); }
    }
    .modalHead{
      padding: 14px 14px 10px;
      background: linear-gradient(180deg, rgba(17,31,53,.92), rgba(11,18,32,.7));
      border-bottom: 1px solid rgba(96,165,250,.18);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .modalHead .t{
      font-weight: 1000;
      color: var(--gold);
      letter-spacing: .2px;
      display:flex; align-items:center; gap:10px;
      font-size: 16px;
    }
    .modalHead .t .gift{
      width:34px; height:34px; border-radius:14px;
      display:grid; place-items:center;
      background: radial-gradient(circle at 30% 30%, rgba(251,191,36,.95), rgba(251,191,36,.1));
      box-shadow: 0 0 0 2px rgba(251,191,36,.18), 0 18px 40px rgba(251,191,36,.18);
    }
    .closeX{
      width:38px; height:38px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.7);
      color: rgba(229,231,235,.9);
      font-weight: 1000;
      cursor:pointer;
    }
    .modalBody{ padding: 14px; }
    .modalBody .big{
      font-weight: 1000;
      font-size: 15px;
      line-height:1.4;
    }
    .modalBody .muted{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      line-height:1.35;
    }
    .modalActions{
      display:flex;
      gap:10px;
      padding: 0 14px 14px;
    }

    /* Addons panel (display only) */
    .addons{
      border-radius: var(--r2);
      background: rgba(11,18,32,.72);
      border: 1px solid rgba(96,165,250,.16);
      box-shadow: var(--shadow2);
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    .addons h3{ margin:0 0 8px; font-size: 14px; font-weight: 1000; }
    .addonGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .addon{
      border-radius: 16px;
      padding: 10px 10px;
      background: rgba(15,23,42,.78);
      border: 1px solid rgba(148,163,184,.14);
      display:flex; justify-content:space-between; gap:10px;
      font-size: 12px;
      font-weight: 900;
      color: rgba(229,231,235,.92);
    }
    .addon span{
      color: rgba(156,163,175,.92);
      font-weight: 900;
      white-space:nowrap;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: max(18px, env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(11,18,32,.9);
      border: 1px solid rgba(96,165,250,.22);
      border-radius: 16px;
      padding: 10px 12px;
      z-index: 80;
      color: rgba(229,231,235,.92);
      font-size: 12px;
      font-weight: 900;
      box-shadow: var(--shadow2);
      display:none;
      max-width: min(520px, calc(100vw - 28px));
    }
    .toast.show{
      display:block;
      animation: toastIn .2s ease forwards;
    }
    @keyframes toastIn{
      from{ opacity:0; transform: translateX(-50%) translateY(6px); }
      to{ opacity:1; transform: translateX(-50%) translateY(0); }
    }
  </style>
</head>
<body>
  <canvas id="bgFx"></canvas>

  <div class="app">
    <section class="hud">
      <div class="hudTop">
        <div class="title">
          <div class="badge">ğŸ°</div>
          <div>
            ä»Šå¤©åƒå•¥ Â· éœ“è™¹å¼€ç®±ï¼ˆæ‰‹æœºç‰ˆï¼‰
            <div class="sub">è§„åˆ™ï¼šä¸»é£Ÿ 1 ä»½ + å‡‰èœ/å°é£Ÿ 1 ä»½ï¼ˆä¸å«åŠ æ–™åŒºï¼‰ Â· æ”¯æŒéŸ³æ•ˆ/éœ‡åŠ¨/å½©çº¸</div>
          </div>
        </div>
      </div>
      <div class="hudBottom">
        <div class="status" id="status">
          <i class="dot" id="statusDot"></i>
          <span id="statusText">çŠ¶æ€ï¼šå¾…å¼€ç®±</span>
        </div>
        <button class="btn" id="btnRoll">ğŸš€ å¼€ç®±æŠ½å¥–</button>
      </div>
    </section>

    <section class="banner">
      <div class="bolt">âš¡</div>
      <div class="bannerText" id="bannerText">ğŸ”¥ ä»Šæ—¥å¹¸è¿ç»„åˆï¼šé©¬ä¸Šæ­æ™“</div>
    </section>

    <section class="reels">
      <div class="reelsInner">
        <div class="reel" id="reelMain">
          <div class="reelHeader">
            <div class="reelTitle">ğŸœ ä¸»é£Ÿ Â· 1ä»½</div>
            <div class="pill" id="mainPoolPill">æŠ½å¥–æ± ï¼šå…¨éƒ¨ä¸»é£Ÿ</div>
          </div>
          <div class="viewport">
            <div class="card" id="mainCard">
              <div class="name" id="mainName">â€”</div>
              <div class="price" id="mainPrice">â€”</div>
              <div class="glowbar"><i id="mainGlow"></i></div>
            </div>
          </div>
        </div>

        <div class="reel" id="reelSide">
          <div class="reelHeader">
            <div class="reelTitle">ğŸ¥— å‡‰èœ/å°é£Ÿ Â· 1ä»½</div>
            <div class="pill" id="sidePoolPill">æŠ½å¥–æ± ï¼šå‡‰èœ/å°é£Ÿ + å°èœåŒº</div>
          </div>
          <div class="viewport">
            <div class="card" id="sideCard">
              <div class="name" id="sideName">â€”</div>
              <div class="price" id="sidePrice">â€”</div>
              <div class="glowbar"><i id="sideGlow"></i></div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn secondary" id="btnCopy">ğŸ“‹ å¤åˆ¶ç‚¹å•</button>
          <button class="btn ghost" id="btnClear">ğŸ—‘ æ¸…ç©ºå†å²</button>
        </div>
      </div>
    </section>

    <section class="settings">
      <h3>âš™ï¸ æ¸¸æˆè®¾ç½®</h3>
      <div class="row">
        <label>é¿å…è¿ç»­é‡å¤</label>
        <div class="tog">
          <div class="switch on" id="swAvoid"></div>
          <span id="txtAvoid">ON</span>
        </div>
      </div>

      <div class="row">
        <label>ä¾§èœåŒ…å«â€œå°èœåŒº/è‚‰å¤¹é¦â€</label>
        <div class="tog">
          <div class="switch on" id="swSmall"></div>
          <span id="txtSmall">ON</span>
        </div>
      </div>

      <div class="row">
        <label>éŸ³æ•ˆï¼ˆä¸æ”¯æŒå°±é™éŸ³ï¼‰</label>
        <div class="tog">
          <div class="switch on" id="swSound"></div>
          <span id="txtSound">ON</span>
        </div>
      </div>

      <div style="padding-top:10px">
        <div style="font-size:12px;font-weight:1000;color:rgba(147,197,253,.95);margin-bottom:8px">ä¸»é£ŸæŠ½å¥–æ± ï¼ˆç‚¹é€‰å‚ä¸ï¼‰</div>
        <div class="chips" id="mainChips"></div>
        <div class="hint">ä½ å¯ä»¥æŠŠä¸»é£Ÿæ± ç¼©å°åˆ°â€œå°±æƒ³åƒé¢/å°±æƒ³åƒé¥­â€ã€‚æ²¡å‹¾é€‰ä»»ä½•ä¸»é£Ÿä¼šæç¤ºã€‚</div>
      </div>
    </section>

    <section class="history">
      <div class="historyTop">
        <h3>ğŸ“œ å¼€ç®±è®°å½•ï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰</h3>
        <button class="btn ghost" style="min-width:120px;padding:10px 12px;border-radius:14px" id="btnReroll">ğŸ” å†æ¥ä¸€æ¬¡</button>
      </div>
      <div class="historyList" id="historyList"></div>
    </section>

    <section class="addons">
      <h3>ğŸ§¾ åŠ æ–™åŒºï¼ˆå±•ç¤ºç”¨ï¼Œä¸å‚ä¸æŠ½å¥–ï¼‰</h3>
      <div class="hint">ä½ æŠ½å‡ºæ¥çš„ç»„åˆä¸åŒ…å«åŠ æ–™ï¼›è¿™é‡Œç»™ä½ æ‰‹åŠ¨å‚è€ƒåŠ ç‚¹å•¥ã€‚</div>
      <div class="addonGrid" id="addonGrid"></div>
    </section>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modalCard" id="modalCard">
      <div class="modalHead">
        <div class="t"><span class="gift">ğŸ</span> å¼€ç®±æˆåŠŸ Â· ä»Šæ—¥ç‚¹å•</div>
        <button class="closeX" id="btnClose">âœ•</button>
      </div>
      <div class="modalBody">
        <div class="big" id="modalText">â€”</div>
        <div class="muted">æç¤ºï¼šç‚¹â€œå¤åˆ¶ç‚¹å•â€ç›´æ¥å‘ç»™åº—å®¶ Â· ç‚¹å‡»ç©ºç™½å¤„ä¹Ÿå¯å…³é—­</div>
      </div>
      <div class="modalActions">
        <button class="btn secondary" id="btnCopy2">ğŸ“‹ å¤åˆ¶ç‚¹å•</button>
        <button class="btn ghost" id="btnClose2">å…³é—­</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">â€”</div>

  <script>
    // =========================
    // æ•°æ®ï¼ˆæŒ‰ä½ æœ€æ–°èœå•è¡¥å…¨ï¼‰
    // =========================
    const MENU = {
      MAIN_NOODLES: [
        ["ç‰›è‚‰æ‹‰é¢", 2000],
        ["ç‰›è‚‰åˆ€å‰Šé¢", 2000],
        ["çº¢çƒ§ç‰›è‚‰é¢", 2600],
        ["çº¢çƒ§ç‰›è‚‰åˆ€å‰Šé¢", 2600],
        ["é…¸èœç‰›è‚‰é¢", 2600],
        ["é…¸èœç‰›è‚‰åˆ€å‰Šé¢", 2600],
        ["é¸¡è‚‰æ‹‰é¢", 2000],
        ["é¸¡è›‹æ‹‰é¢", 2000],
        ["é¸¡è›‹åˆ€å‰Šé¢", 2000],
        ["è¥¿çº¢æŸ¿é¸¡è›‹æ‹‰é¢", 2300],
        ["è¥¿çº¢æŸ¿é¸¡è›‹åˆ€å‰Šé¢", 2300],
      ],
      MAIN_PAO_MO: [
        ["ç‰›è‚‰æ³¡é¦", 3000],
      ],
      MAIN_FRY_NOODLES: [
        ["ç‰›è‚‰ç‚’æ‹‰é¢", 3000],
        ["ç‰›è‚‰ç‚’åˆ€å‰Šé¢", 3000],
        ["é¸¡è‚‰ç‚’æ‹‰é¢", 3000],
        ["é¸¡è‚‰ç‚’åˆ€å‰Šé¢", 3000],
        ["é¸¡è›‹ç‚’æ‹‰é¢", 3000],
        ["é¸¡è›‹ç‚’åˆ€å‰Šé¢", 3000],
        ["è¥¿çº¢æŸ¿ç‚’æ‹‰é¢", 3000],
        ["è¥¿çº¢æŸ¿ç‚’åˆ€å‰Šé¢", 3000],
        ["ç‰›è‚‰ç‚’é¢ç‰‡", 3200],
        ["é¸¡è›‹ç‚’é¢ç‰‡", 3200],
      ],
      MAIN_MIX_NOODLES: [
        ["ç‰›è‚‰å‡‰é¢", 3000],
        ["åœŸè±†ç‰›è‚‰é¢", 3000],
        ["å­œç„¶ç‰›è‚‰æ‹Œé¢", 3200],
        ["è‘±çˆ†ç‰›è‚‰æ‹Œé¢", 3200],
        ["é’æ¤’ç‰›è‚‰æ‹Œé¢", 3200],
        ["æ–°ç–†æ‹Œé¢", 3200],
        ["çº¢çƒ§ç‰›è‚‰æ‹Œé¢", 3200],
        ["æ´‹è‘±ç‰›è‚‰æ‹Œé¢", 3200],
        ["æœ¨è€³ç‰›è‚‰æ‹Œé¢", 3200],
        ["è¥¿çº¢æŸ¿é¸¡è›‹æ‹Œé¢", 3000],
        ["é’æ¤’åœŸè±†ä¸æ‹Œé¢", 2500],
        ["é…¸è¾£ç™½èœæ‹Œé¢", 2500],
      ],
      MAIN_RICE: [
        ["ç‰›è‚‰ç‚’é¥­", 2000],
        ["é¸¡è‚‰ç‚’é¥­", 2000],
        ["é¸¡è›‹ç‚’é¥­", 2000],
        ["åœŸè±†ç‰›è‚‰ç›–æµ‡é¥­", 3000],
        ["è‘±çˆ†ç‰›è‚‰ç›–æµ‡é¥­", 3200],
        ["é’æ¤’ç‰›è‚‰ç›–æµ‡é¥­", 3000],
        ["çº¢çƒ§ç‰›è‚‰ç›–æµ‡é¥­", 3200],
        ["æ´‹è‘±ç‰›è‚‰ç›–æµ‡é¥­", 2800],
        ["æœ¨è€³ç‰›è‚‰ç›–æµ‡é¥­", 3200],
        ["è¥¿çº¢æŸ¿é¸¡è›‹ç›–æµ‡é¥­", 2500],
        ["é’æ¤’åœŸè±†ä¸ç›–æµ‡é¥­", 2500],
        ["é…¸è¾£ç™½èœç›–æµ‡é¥­", 2500],
        ["å­œç„¶ç‰›è‚‰ç›–æµ‡é¥­", 3200],
      ],
      HOT_DISHES: [
        ["ç´ ç‚’ä¸Šæµ·é’", 2500],
        ["é’æ¤’åœŸè±†ä¸", 2500],
        ["é…¸è¾£ç™½èœ", 2500],
        ["è¥¿çº¢æŸ¿ç‚’é¸¡è›‹", 2500],
        ["é’æ¤’ç‚’é¸¡è›‹", 2500],
        ["åœŸè±†çƒ§ç‰›è‚‰", 3800],
        ["é’æ¤’ç‚’ç‰›è‚‰", 3800],
        ["å­œç„¶ç‚’ç‰›è‚‰", 3800],
        ["è‘±çˆ†ç‚’ç‰›è‚‰", 3800],
        ["æ–°ç–†å°ç›˜é¸¡", 12000],
        ["æ–°ç–†å¤§ç›˜é¸¡", 15000],
      ],
      SIDE_COLD_SNACKS: [
        ["å‡‰æ‹Œç‰›è‚‰", 4600],
        ["æ¤’éº»é¸¡", 3000],
        ["å‡‰æ‹Œé»„ç“œ", 2500],
        ["å‡‰æ‹ŒåœŸè±†ä¸", 2500],
        ["è‘±æ²¹é¥¼", 1000],
      ],
      SIDE_SMALL_DISHES: [
        ["è‚‰å¤¹é¦", 1500],
        ["å°èœé»„ç“œ", 1500],
        ["å°èœåœŸè±†ä¸", 1500],
        ["å°èœæ‹¼ç›˜", 1500],
      ],
      ADDONS: [
        ["ç±³é¥­", 500],
        ["ç…è›‹", 400],
        ["åŠ é¢ï¼ˆä¸€ä»½ï¼‰", 1000],
        ["åŠ è‚‰ï¼ˆä¸€ä»½ï¼‰", 1500],
        ["å¯ä¹", 400],
        ["é›ªç¢§", 400],
        ["èŠ¬è¾¾", 400],
        ["æ‰“åŒ…ç›’", 100],
      ]
    };

    // =========================
    // å·¥å…·
    // =========================
    const $ = (id)=>document.getElementById(id);
    const fmt = (item)=> `${item[0]} Â· ${item[1]}RS`;
    const clamp = (x,a,b)=> Math.max(a, Math.min(b,x));
    const easeOutCubic = (t)=> 1 - Math.pow(1-t,3);

    // ç®€æ˜“éŸ³æ•ˆï¼šWebAudioï¼ˆè‹¥è¢«æµè§ˆå™¨ç­–ç•¥ç¦ç”¨å°±è‡ªåŠ¨é™éŸ³ï¼‰
    let audioCtx = null;
    function ensureAudio(){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === "suspended") audioCtx.resume();
        return true;
      }catch(e){
        return false;
      }
    }
    function beep(freq=880, dur=0.05, vol=0.05){
      if(!state.sound) return;
      if(!ensureAudio()) return;
      const t0 = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.value = freq;
      g.gain.value = vol;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(t0);
      o.stop(t0 + dur);
    }
    function beepClick(){ beep(880, .05, .05); }
    function beepTick(){ beep(1200, .018, .03); }
    function beepWin(){
      beep(988,.09,.05);
      setTimeout(()=>beep(1319,.09,.05), 95);
      setTimeout(()=>beep(1760,.12,.05), 190);
    }

    // æ‰‹æœºéœ‡åŠ¨ï¼ˆä¸æ”¯æŒå°±å¿½ç•¥ï¼‰
    function vibrate(pattern){
      try{ if(navigator.vibrate) navigator.vibrate(pattern); }catch(e){}
    }

    function pick(pool){ return pool[Math.floor(Math.random()*pool.length)]; }
    function safePick(pool, last, avoid){
      if(!pool.length) return ["ï¼ˆæ— å¯æŠ½é€‰é¡¹ï¼‰", 0];
      if(!avoid || !last || pool.length===1) return pick(pool);
      for(let i=0;i<12;i++){
        const p = pick(pool);
        if(p[0] !== last[0]) return p;
      }
      return pick(pool);
    }

    function copyText(text){
      return navigator.clipboard?.writeText(text).then(()=>true).catch(()=>false);
    }

    // =========================
    // çŠ¶æ€
    // =========================
    const state = {
      rolling:false,
      avoid:true,
      sideSmall:true,
      sound:true,
      mainCats:{
        noodles:true,
        fry:true,
        mix:true,
        pao:true,
        rice:true,
      },
      lastMain:null,
      lastSide:null,
      history: []
    };

    // =========================
    // UI å¼•ç”¨
    // =========================
    const ui = {
      statusText: $("statusText"),
      statusDot: $("statusDot"),
      bannerText: $("bannerText"),
      btnRoll: $("btnRoll"),
      btnReroll: $("btnReroll"),
      btnCopy: $("btnCopy"),
      btnClear: $("btnClear"),

      mainName: $("mainName"),
      mainPrice: $("mainPrice"),
      mainGlow: $("mainGlow"),
      mainCard: $("mainCard"),
      reelMain: $("reelMain"),

      sideName: $("sideName"),
      sidePrice: $("sidePrice"),
      sideGlow: $("sideGlow"),
      sideCard: $("sideCard"),
      reelSide: $("reelSide"),

      swAvoid: $("swAvoid"), txtAvoid: $("txtAvoid"),
      swSmall: $("swSmall"), txtSmall: $("txtSmall"),
      swSound: $("swSound"), txtSound: $("txtSound"),

      mainChips: $("mainChips"),
      mainPoolPill: $("mainPoolPill"),
      sidePoolPill: $("sidePoolPill"),

      historyList: $("historyList"),

      modal: $("modal"),
      modalText: $("modalText"),
      btnClose: $("btnClose"),
      btnClose2: $("btnClose2"),
      btnCopy2: $("btnCopy2"),
      toast: $("toast"),

      addonGrid: $("addonGrid"),
    };

    function setStatus(text, color="blue"){
      ui.statusText.textContent = text;
      ui.statusDot.style.background =
        color==="ok" ? "rgba(52,211,153,.95)" :
        color==="warn" ? "rgba(251,113,133,.95)" :
        "rgba(147,197,253,.95)";
      ui.statusDot.style.boxShadow =
        color==="ok" ? "0 0 14px rgba(52,211,153,.55)" :
        color==="warn" ? "0 0 14px rgba(251,113,133,.55)" :
        "0 0 14px rgba(147,197,253,.55)";
    }

    function showToast(text){
      ui.toast.textContent = text;
      ui.toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>ui.toast.classList.remove("show"), 1400);
    }

    // =========================
    // æŠ½å¥–æ± 
    // =========================
    function getMainPool(){
      let pool = [];
      if(state.mainCats.noodles) pool = pool.concat(MENU.MAIN_NOODLES);
      if(state.mainCats.fry) pool = pool.concat(MENU.MAIN_FRY_NOODLES);
      if(state.mainCats.mix) pool = pool.concat(MENU.MAIN_MIX_NOODLES);
      if(state.mainCats.pao) pool = pool.concat(MENU.MAIN_PAO_MO);
      if(state.mainCats.rice) pool = pool.concat(MENU.MAIN_RICE);
      return pool;
    }
    function getSidePool(){
      let pool = MENU.SIDE_COLD_SNACKS.slice();
      if(state.sideSmall) pool = pool.concat(MENU.SIDE_SMALL_DISHES);
      return pool;
    }

    function updatePoolPills(){
      const mainOn = Object.entries(state.mainCats).filter(([,v])=>v).map(([k])=>k);
      const map = {
        noodles: "æ‹›ç‰Œé¢",
        fry: "ç‚’é¢",
        mix: "æ‹Œé¢",
        pao: "æ³¡é¦",
        rice: "é¥­ç±»"
      };
      const label = mainOn.length===5 ? "å…¨éƒ¨ä¸»é£Ÿ" : (mainOn.map(k=>map[k]).join(" + ") || "æœªå‹¾é€‰");
      ui.mainPoolPill.textContent = "æŠ½å¥–æ± ï¼š" + label;

      ui.sidePoolPill.textContent = "æŠ½å¥–æ± ï¼š" + (state.sideSmall ? "å‡‰èœ/å°é£Ÿ + å°èœåŒº" : "ä»…å‡‰èœ/å°é£Ÿ");
    }

    // =========================
    // è€è™æœºå·è½´ï¼ˆå‰å¿«åæ…¢ï¼‰
    // =========================
    async function rollReel(kind, pool, lastRef){
      // kind: "main" or "side"
      const totalTicks = (kind==="main") ? 26 : 28;
      const base = 40;
      const elName = (kind==="main") ? ui.mainName : ui.sideName;
      const elPrice = (kind==="main") ? ui.mainPrice : ui.sidePrice;
      const elGlow = (kind==="main") ? ui.mainGlow : ui.sideGlow;
      const card = (kind==="main") ? ui.mainCard : ui.sideCard;

      // é¢„è®¡ç®—é—´éš”ï¼šå…ˆå¿«åæ…¢
      const intervals = [];
      for(let i=0;i<totalTicks;i++){
        const t = i/(totalTicks-1);
        const slow = easeOutCubic(t);
        const ms = Math.round(base + slow*140);
        intervals.push(ms);
      }

      for(let i=0;i<totalTicks;i++){
        const tmp = pick(pool);
        elName.textContent = tmp[0];
        elPrice.textContent = tmp[1] + "RS";
        elGlow.style.width = Math.round(((i+1)/totalTicks)*100) + "%";
        card.classList.remove("pop"); void card.offsetWidth; // reflow for animation
        card.classList.add("shake");
        setTimeout(()=>card.classList.remove("shake"), 180);
        beepTick();
        if(i%6===0) vibrate(8);
        await new Promise(r=>setTimeout(r, intervals[i]));
      }

      const finalItem = safePick(pool, lastRef.value, state.avoid);
      elName.textContent = finalItem[0];
      elPrice.textContent = finalItem[1] + "RS";
      elGlow.style.width = "100%";
      card.classList.remove("pop"); void card.offsetWidth;
      card.classList.add("pop");
      vibrate([18, 30, 18]);
      return finalItem;
    }

    // =========================
    // è®°å½• / å¼¹çª— / å¤åˆ¶
    // =========================
    function pushHistory(main, side){
      const total = main[1] + side[1];
      const entry = {
        t: Date.now(),
        main, side, total
      };
      state.history.unshift(entry);
      renderHistory();
      return total;
    }

    function renderHistory(){
      ui.historyList.innerHTML = "";
      if(state.history.length===0){
        const empty = document.createElement("div");
        empty.className = "hitem";
        empty.innerHTML = `<div class="line">è¿˜æ²¡æœ‰è®°å½•</div><div class="small">æŠ½ä¸€å‘å°±æœ‰äº†</div>`;
        ui.historyList.appendChild(empty);
        return;
      }
      for(const h of state.history.slice(0, 12)){
        const d = new Date(h.t);
        const t = d.toLocaleString("zh-CN", {hour:"2-digit", minute:"2-digit", month:"2-digit", day:"2-digit"});
        const div = document.createElement("div");
        div.className = "hitem";
        div.innerHTML = `
          <div class="line">ğŸœ ${fmt(h.main)} <span class="sep">|</span> ğŸ¥— ${fmt(h.side)}</div>
          <div class="small">ğŸ’° åˆè®¡ï¼š${h.total}RS <span class="sep">|</span> ${t}</div>
        `;
        ui.historyList.appendChild(div);
      }
    }

    function openModal(main, side, total){
      ui.modalText.innerHTML = `ğŸœ ä¸»é£Ÿï¼š<b>${fmt(main)}</b><br/>ğŸ¥— ä¾§èœï¼š<b>${fmt(side)}</b><br/><br/>ğŸ’° åˆè®¡ï¼š<b>${total}RS</b>`;
      ui.modal.classList.add("show");
      // å½©çº¸ + éŸ³æ•ˆ
      beepWin();
      burstConfetti();
    }
    function closeModal(){
      ui.modal.classList.remove("show");
    }

    function buildOrderText(){
      if(!state.lastMain || !state.lastSide) return "";
      const total = state.lastMain[1] + state.lastSide[1];
      return `âœ… ä»Šæ—¥ç‚¹å•ï¼ˆæŠ½å¥–ï¼‰\nğŸœ ä¸»é£Ÿï¼š${fmt(state.lastMain)}\nğŸ¥— ä¾§èœï¼š${fmt(state.lastSide)}\nğŸ’° åˆè®¡ï¼š${total}RS`;
    }

    async function doCopy(){
      const s = buildOrderText();
      if(!s){
        setStatus("çŠ¶æ€ï¼šè¿˜æ²¡æŠ½åˆ°ç»“æœ", "warn");
        showToast("å…ˆæŠ½å¥–ï¼Œå†å¤åˆ¶");
        return;
      }
      const ok = await copyText(s);
      if(ok){
        setStatus("çŠ¶æ€ï¼šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "ok");
        showToast("âœ… å·²å¤åˆ¶");
        beepClick();
        vibrate(12);
      }else{
        showToast("å¤åˆ¶å¤±è´¥ï¼šæµè§ˆå™¨é™åˆ¶ï¼ˆè¯·é•¿æŒ‰æ‰‹åŠ¨å¤åˆ¶ï¼‰");
      }
    }

    // =========================
    // ä¸»æµç¨‹ï¼šå¼€ç®±æŠ½å¥–
    // =========================
    async function rollNow(){
      if(state.rolling) return;

      const mainPool = getMainPool();
      const sidePool = getSidePool();

      if(mainPool.length===0){
        setStatus("çŠ¶æ€ï¼šä¸»é£ŸæŠ½å¥–æ± ä¸ºç©ºï¼ˆè‡³å°‘å‹¾é€‰ä¸€ä¸ªï¼‰", "warn");
        ui.reelMain.classList.add("shake");
        setTimeout(()=>ui.reelMain.classList.remove("shake"), 260);
        return;
      }
      if(sidePool.length===0){
        setStatus("çŠ¶æ€ï¼šä¾§èœæŠ½å¥–æ± ä¸ºç©º", "warn");
        ui.reelSide.classList.add("shake");
        setTimeout(()=>ui.reelSide.classList.remove("shake"), 260);
        return;
      }

      state.rolling = true;
      ui.btnRoll.disabled = true;
      ui.btnReroll.disabled = true;
      ui.btnRoll.textContent = "æŠ½å¥–ä¸­â€¦";
      ui.bannerText.textContent = "âš¡ è€è™æœºå¯åŠ¨ï¼šå¥½è¿åŠ è½½ä¸­â€¦";
      ui.bannerText.style.color = "var(--gold)";
      setStatus("çŠ¶æ€ï¼šå¼€ç®±ä¸­â€¦", "blue");
      beepClick();
      vibrate(18);

      const lastMainRef = { value: state.lastMain };
      const lastSideRef = { value: state.lastSide };

      // ä¸¤å·è½´ä¸åŒæ­¥ç»“æŸï¼šä¾§èœå»¶è¿Ÿå¯åŠ¨æ›´â€œæ¸¸æˆâ€
      const pMain = rollReel("main", mainPool, lastMainRef);
      await new Promise(r=>setTimeout(r, 220));
      const pSide = rollReel("side", sidePool, lastSideRef);

      const [main, side] = await Promise.all([pMain, pSide]);

      state.lastMain = main;
      state.lastSide = side;

      const total = pushHistory(main, side);

      state.rolling = false;
      ui.btnRoll.disabled = false;
      ui.btnReroll.disabled = false;
      ui.btnRoll.textContent = "ğŸš€ å†å¼€ä¸€ç®±";
      setStatus(`çŠ¶æ€ï¼šå·²æŠ½ä¸­ âœ… åˆè®¡ ${total}RS`, "ok");
      ui.bannerText.textContent = "ğŸ‰ ç»“æœå·²æ­æ™“ï¼šä¸çº ç»“ï¼Œç›´æ¥åƒï¼";
      ui.bannerText.style.color = "var(--ok)";

      openModal(main, side, total);
    }

    // =========================
    // è®¾ç½® UI
    // =========================
    function initSwitch(sw, txtEl, key){
      function sync(){
        const v = state[key];
        sw.classList.toggle("on", !!v);
        txtEl.textContent = v ? "ON" : "OFF";
      }
      sw.addEventListener("click", ()=>{
        state[key] = !state[key];
        sync();
        updatePoolPills();
        beepClick();
        vibrate(8);
      });
      sync();
    }

    function initChips(){
      const chips = [
        {k:"noodles", label:"æ‹›ç‰Œé¢/åˆ€å‰Š"},
        {k:"fry", label:"ç‚’é¢ç±»"},
        {k:"mix", label:"æ‹Œé¢ç±»"},
        {k:"pao", label:"æ³¡é¦ç±»"},
        {k:"rice", label:"é¥­ç±»"},
      ];
      ui.mainChips.innerHTML = "";
      for(const c of chips){
        const b = document.createElement("div");
        b.className = "chip on";
        b.textContent = c.label;
        b.addEventListener("click", ()=>{
          state.mainCats[c.k] = !state.mainCats[c.k];
          b.classList.toggle("on", !!state.mainCats[c.k]);
          updatePoolPills();
          beepClick();
          vibrate(8);
        });
        ui.mainChips.appendChild(b);
      }
      updatePoolPills();
    }

    function renderAddons(){
      ui.addonGrid.innerHTML = "";
      for(const a of MENU.ADDONS){
        const div = document.createElement("div");
        div.className = "addon";
        div.innerHTML = `<div>${a[0]}</div><span>${a[1]}RS</span>`;
        ui.addonGrid.appendChild(div);
      }
    }

    // =========================
    // èƒŒæ™¯æ˜Ÿå°˜ + å½©çº¸çˆ†ç‚¸
    // =========================
    const fx = {
      canvas: $("bgFx"),
      ctx: null,
      w: 0, h: 0, dpr: 1,
      stars: [],
      confetti: [],
      last: 0,
    };

    function resizeFx(){
      fx.dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      fx.w = Math.floor(window.innerWidth);
      fx.h = Math.floor(window.innerHeight);
      fx.canvas.width = Math.floor(fx.w * fx.dpr);
      fx.canvas.height = Math.floor(fx.h * fx.dpr);
      fx.canvas.style.width = fx.w + "px";
      fx.canvas.style.height = fx.h + "px";
      fx.ctx = fx.canvas.getContext("2d");
      fx.ctx.setTransform(fx.dpr,0,0,fx.dpr,0,0);
      initStars();
    }

    function initStars(){
      fx.stars = [];
      const n = 70;
      for(let i=0;i<n;i++){
        fx.stars.push({
          x: Math.random()*fx.w,
          y: Math.random()*fx.h,
          r: Math.random()<.7 ? 1 : 2,
          sp: 10 + Math.random()*35,
          a: 0.15 + Math.random()*0.35
        });
      }
    }

    function burstConfetti(){
      const cx = fx.w/2;
      const cy = fx.h*0.25;
      const colors = ["#22c55e","#60a5fa","#f59e0b","#fb7185","#a78bfa","#34d399","#f43f5e"];
      const count = 180;
      for(let i=0;i<count;i++){
        const vx = (Math.random()*840 - 420);
        const vy = -(260 + Math.random()*520);
        fx.confetti.push({
          x: cx, y: cy,
          vx, vy,
          g: 900 + Math.random()*450,
          s: 4 + Math.random()*8,
          r: Math.random()*Math.PI*2,
          rv: (Math.random()*18-9),
          life: 0.9 + Math.random()*0.7,
          t: 0,
          c: colors[(Math.random()*colors.length)|0]
        });
      }
    }

    function tickFx(ts){
      if(!fx.last) fx.last = ts;
      const dt = clamp((ts - fx.last)/1000, 0.001, 0.035);
      fx.last = ts;

      const ctx = fx.ctx;
      if(!ctx) return requestAnimationFrame(tickFx);

      // èƒŒæ™¯ï¼šé€æ˜æ¸…å±ï¼ˆè®© body æ¸å˜é€å‡ºæ¥ï¼‰
      ctx.clearRect(0,0,fx.w,fx.h);

      // æ˜Ÿå°˜
      for(const s of fx.stars){
        s.y += s.sp*dt;
        if(s.y > fx.h+10){ s.y = -10; s.x = Math.random()*fx.w; }
        ctx.globalAlpha = s.a;
        ctx.fillStyle = "#93c5fd";
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fill();
      }
      ctx.globalAlpha = 1;

      // å½©çº¸
      const alive = [];
      for(const p of fx.confetti){
        p.t += dt;
        p.vy += p.g*dt;
        p.x += p.vx*dt;
        p.y += p.vy*dt;
        p.r += p.rv*dt;
        p.vx *= (1 - 0.15*dt);
        p.vy *= (1 - 0.05*dt);

        if(p.t < p.life && p.y < fx.h+80 && p.x > -80 && p.x < fx.w+80){
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.r);
          ctx.fillStyle = p.c;
          const wob = Math.sin(p.r*2)* (p.s*0.6);
          ctx.fillRect(-p.s, -p.s, p.s*2+wob, p.s*2);
          ctx.restore();
          alive.push(p);
        }
      }
      fx.confetti = alive;

      requestAnimationFrame(tickFx);
    }

    // =========================
    // äº‹ä»¶ç»‘å®š
    // =========================
    ui.btnRoll.addEventListener("click", rollNow);
    ui.btnReroll.addEventListener("click", rollNow);
    ui.btnCopy.addEventListener("click", doCopy);
    ui.btnCopy2.addEventListener("click", doCopy);
    ui.btnClear.addEventListener("click", ()=>{
      state.history = [];
      renderHistory();
      setStatus("çŠ¶æ€ï¼šå†å²å·²æ¸…ç©º", "blue");
      ui.bannerText.textContent = "ğŸ§¹ æ¸…ç©ºå®Œæ¯•ï¼šå†å¼€ä¸€ç®±";
      ui.bannerText.style.color = "rgba(147,197,253,.95)";
      beepClick();
      vibrate(10);
    });

    ui.btnClose.addEventListener("click", closeModal);
    ui.btnClose2.addEventListener("click", closeModal);
    ui.modal.addEventListener("click", (e)=>{
      if(e.target === ui.modal) closeModal();
    });

    // æ–¹ä¾¿ï¼šå›è½¦æŠ½å¥–ã€Esc å…³å¼¹çª—ï¼ˆéƒ¨åˆ†å®‰å“æµè§ˆå™¨ä¸è§¦å‘é”®ç›˜äº‹ä»¶ï¼Œæ²¡å…³ç³»ï¼‰
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") rollNow();
      if(e.key === "Escape") closeModal();
    });

    // switches
    initSwitch(ui.swAvoid, ui.txtAvoid, "avoid");
    initSwitch(ui.swSmall, ui.txtSmall, "sideSmall");
    initSwitch(ui.swSound, ui.txtSound, "sound");

    initChips();
    renderHistory();
    renderAddons();

    // åˆå§‹åŒ–èƒŒæ™¯ FX
    resizeFx();
    window.addEventListener("resize", resizeFx);
    requestAnimationFrame(tickFx);

    // é¦–å±æç¤º
    setStatus("çŠ¶æ€ï¼šå¾…å¼€ç®±", "blue");
    updatePoolPills();
  </script>
</body>
</html>
